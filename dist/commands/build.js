"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.build=void 0;var _path=_interopRequireDefault(require("path"));var _rimraf2=_interopRequireDefault(require("rimraf"));var _webpack2=_interopRequireDefault(require("webpack"));var _util=require("util");var _log=_interopRequireDefault(require("../utils/log"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var rimraf=(0,_util.promisify)(_rimraf2["default"]);var webpack=function webpack(config){return new Promise(function(resolve,reject){return(0,_webpack2["default"])(config,function(error,stats){var err=error||stats.hasErrors();if(err){reject("SchemeBuildError: WebpackError: \n".concat(error||stats.compilation.errors))}resolve(config)})})};var babelLoader={loader:require.resolve("babel-loader"),options:{presets:[require.resolve("@babel/preset-env")]}};var schemeLoader=_path["default"].resolve(__dirname,"../utils/scheme-loader.js");var makeConfig=function makeConfig(entry,dir,filename){return function(){return new Promise(function(resolve){return resolve({entry:entry,mode:"production",module:{rules:[{use:[babelLoader,schemeLoader]}]},output:{filename:filename,libraryTarget:"umd",globalObject:"this",path:dir}})})}};var getRelativePath=function getRelativePath(filepath){return _path["default"].relative(process.cwd(),filepath)};var logBuildDetails=function logBuildDetails(_ref){var entry=_ref.entry,output=_ref.output;var srcFile=getRelativePath(entry);var outputDir=getRelativePath(output.path);var outputFile=getRelativePath(output.filename);_log["default"].info("SchemeBuild: \"".concat(srcFile,"\" is converted and written to \"").concat(outputDir,"/").concat(outputFile,".\""))};var build=function build(entry,outputDir,outputFile){return function(){return new Promise(function(resolve,reject){rimraf(outputDir).then(makeConfig(entry,outputDir,outputFile)).then(webpack).then(logBuildDetails).then(resolve)["catch"](reject)})}};exports.build=build;